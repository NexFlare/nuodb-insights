{{- if and .Values.config .Values.config.enabled -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-datasource-nuodb
  namespace: {{ include "monitoring-influx.namespace" . }}
  labels:
    {{ .Values.grafana.sidecar.datasources.label | default "grafana_datasource" }}: "nuodb"
    {{- include "monitoring-influx.labels" . | nindent 4 }}
data:
  nuodb.yaml: |-
    apiVersion: 1
    datasources:
      - name: nuodb
        type: influxdb
        access: proxy
        orgId: 1
        url: {{ include "monitoring-influx.influxdb_url" . }}
        password: ''
        user: ''
        database: 'nuodb'
        basicAuth: false
        basicAuthUser: ''
        basicAuthPassword: ''
        withCredentials: false
        isDefault: true
        jsonData:
          timeInterval: '10s'
        secureJsonData: {}
        version: 1
        editable: true
{{- $dot := . -}}
{{- range $db := .Values.config.databases }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $dot.Release.Name }}-datasource-{{ $db }}
  namespace: {{ include "monitoring-influx.namespace" $dot }}
  labels:
    {{ $dot.Values.grafana.sidecar.datasources.label | default "grafana_datasource" }}: "nuodb"
    {{- include "monitoring-influx.labels" $dot | nindent 4 }}
data:
  {{ $db }}.yaml: |-
    apiVersion: 1
    datasources:
      - name: {{ $db }}
        type: influxdb
        access: proxy
        orgId: 1
        url: {{ include "monitoring-influx.influxdb_url" $dot }}
        password: ''
        user: ''
        database: '{{ $db }}'
        basicAuth: false
        basicAuthUser: ''
        basicAuthPassword: ''
        withCredentials: false
        isDefault: false
        jsonData:
          timeInterval: '10s'
        secureJsonData: {}
        version: 1
        editable: true
{{- end -}}
{{- end -}}
